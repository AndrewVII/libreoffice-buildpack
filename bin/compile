#!/usr/bin/env bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2

# config
VERSION="24.8.3"
MINOR_VERSION="24.8"

# LibreOffice Binaries URL
FILE_NAME=libreoffice${VERSION}_x86-64.tar.gz
BUILDPACK_LIBREOFFICE_PACKAGE=https://download.documentfoundation.org/libreoffice/stable/24.8.3/deb/x86_64/LibreOffice_24.8.3_Linux_x86-64_deb.tar.gz
ARCHIVE_NAME=opt/libreoffice${VERSION}

# Create cache directory if it doesn't exist
mkdir -p $CACHE_DIR

# Download LibreOffice binaries if they do not exist in the cache
if ! [ -e $CACHE_DIR/$FILE_NAME ]; then
  echo "-----> LibreOffice: Downloading LibreOffice ${VERSION} binaries from ${BUILDPACK_LIBREOFFICE_PACKAGE}"
  curl -L $BUILDPACK_LIBREOFFICE_PACKAGE -o $CACHE_DIR/$FILE_NAME
fi

# Create necessary directories in the build path
echo "-----> LibreOffice: Extracting LibreOffice ${VERSION} binaries to ${BUILD_DIR}/vendor/libreoffice"
mkdir -p $BUILD_DIR/vendor/

# Extract LibreOffice binaries to vendor/libreoffice
tar xzf $CACHE_DIR/$FILE_NAME -C $BUILD_DIR/vendor/
mv $BUILD_DIR/vendor/opt/libreoffice${VERSION} $BUILD_DIR/vendor/libreoffice

# Set environment variables for LibreOffice
echo "-----> LibreOffice: Setting PATH"

PROFILE_PATH="$BUILD_DIR/.profile.d/libreoffice.sh"
mkdir -p $(dirname $PROFILE_PATH)

# Add LibreOffice to the PATH
echo 'export PATH="$HOME/vendor/libreoffice/program:$PATH"' >> $PROFILE_PATH

echo "-----> LibreOffice installation completed."
